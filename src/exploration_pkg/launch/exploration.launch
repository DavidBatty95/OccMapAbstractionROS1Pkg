<launch>

  <!-- ====================================================== -->
  <!-- GLOBAL FRAMES                                          -->
  <!-- ====================================================== -->
  <arg name="map_frame"  default="map"/>
  <arg name="base_frame" default="base_link"/>
  <arg name="odom_frame" default="odom"/>

  <!-- ====================================================== -->
  <!-- MASTER SWITCH: RADIATION AWARENESS                     -->
  <!-- ====================================================== -->
  <arg name="use_radiation" default="true"/>

  <!-- ====================================================== -->
  <!-- POSE SOURCE                                            -->
  <!-- ====================================================== -->
  <arg name="pose_source" default="odom"/>
  <arg name="amcl_topic"  default="/amcl_pose"/>
  <arg name="odom_topic"  default="/odometry/filtered"/>

  <!-- ====================================================== -->
  <!-- MOVE_BASE â€” tuned for smooth long corridors           -->
  <!-- ====================================================== -->
  <param name="/move_base/controller_frequency" value="18.0"/>
  <param name="/move_base/planner_frequency" value="0.5"/>

  <param name="/move_base/controller_patience" value="12.0"/>
  <param name="/move_base/oscillation_timeout" value="15.0"/>
  <param name="/move_base/oscillation_distance" value="0.35"/>

  <param name="/move_base/DWAPlannerROS/xy_goal_tolerance" value="0.65"/>
  <param name="/move_base/DWAPlannerROS/yaw_goal_tolerance" value="1.00"/>
  <param name="/move_base/DWAPlannerROS/latch_xy_goal_tolerance" value="true"/>

  <param name="/move_base/DWAPlannerROS/max_vel_x" value="0.50"/>
  <param name="/move_base/DWAPlannerROS/min_vel_x" value="0.10"/>
  <param name="/move_base/DWAPlannerROS/max_vel_theta" value="0.90"/>
  <param name="/move_base/DWAPlannerROS/min_vel_theta" value="0.15"/>

  <!-- ====================================================== -->
  <!-- RADIATION GAUSSIAN PROCESS REGRESSION                  -->
  <!-- ====================================================== -->
  <group if="$(arg use_radiation)">
    <node pkg="exploration_pkg"
          type="rad_GPR_node.py"
          name="rad_GPR_node"
          output="screen"
          respawn="true"
          respawn_delay="2.0">

      <param name="use_radiation" value="true"/>

      <param name="map_topic"  value="/map"/>
      <param name="meas_topic" value="/sim_rad_sensor"/>

      <param name="base_frame" value="$(arg base_frame)"/>
      <param name="frame_id"   value="$(arg map_frame)"/>

      <param name="use_reachable_mask" value="true"/>
      <param name="local_radius_m" value="7.0"/>
      <param name="local_margin_m" value="2.5"/>

      <param name="publish_period_s" value="0.40"/>
      <param name="gp_refit_period_s" value="4.0"/>

      <param name="smooth_sigma_cells" value="0.0"/>
      <param name="scale_percentile" value="85.0"/>

      <param name="abs_scale_uSv" value="300.0"/>
      <param name="contrast_k" value="0.14"/>
    </node>
  </group>

  <!-- ====================================================== -->
  <!-- EXPLORATION POLICY â€” high-fidelity radiation aware    -->
  <!-- ====================================================== -->
  <node pkg="exploration_pkg"
        type="exploration_policy_node.py"
        name="exploration_policy"
        output="screen"
        respawn="true"
        respawn_delay="1.0">

    <rosparam>
      startup_delay_s: 2.0
    </rosparam>

    <param name="use_radiation" value="$(arg use_radiation)"/>

    <param name="map_frame"  value="$(arg map_frame)"/>
    <param name="base_frame" value="$(arg base_frame)"/>
    <param name="odom_frame" value="$(arg odom_frame)"/>

    <param name="pose_source" value="$(arg pose_source)"/>
    <param name="amcl_topic"  value="$(arg amcl_topic)"/>
    <param name="odom_topic"  value="$(arg odom_topic)"/>

    <param name="radiation_topic" value="/radiation_costmap"/>
    <param name="radiation_sigma_topic" value="/radiation_sigma"/>

    <param name="goal_hold_min_s" value="18.0"/>
    <param name="replan_period_s" value="4.0"/>
    <param name="preplan_period_s" value="2.0"/>
    <param name="preplan_min_progress" value="0.85"/>

    <param name="nav_stale_reset_s" value="18.0"/>
    <param name="nav_progress_eps" value="0.005"/>
    <param name="nav_spinup_grace_s" value="8.0"/>
    <param name="require_progress_update_for_preplan" value="false"/>

    <param name="radiation_weight" value="1.8"/>
    <param name="variance_weight" value="0.4"/>
    <param name="radiation_edge_weight" value="0.6"/>
    <param name="astar_rad_integral_weight" value="4.0"/>
    <param name="astar_rad_sample_step_m" value="0.20"/>

    <param name="radiation_goal_soft_cap" value="0.35"/>
    <param name="radiation_goal_hard_cap" value="0.55"/>
    <param name="radiation_softcap_penalty" value="6.0"/>
    <param name="radiation_hardcap_reject" value="true"/>
    
    <param name="enable_radiation_exclusion" value="true"/>
    <param name="radiation_exclusion_threshold" value="0.55"/>
    <param name="radiation_exclusion_inflate_m" value="0.45"/>

  </node>

  <!-- ====================================================== -->
  <!-- CORRIDOR NAVIGATION EXECUTOR                           -->
  <!-- ====================================================== -->
  <node pkg="exploration_pkg"
        type="navigation_corridor_node.py"
        name="navigation_corridor"
        output="screen"
        respawn="true"
        respawn_delay="1.0">

    <param name="map_frame" value="$(arg map_frame)"/>
    <param name="base_frame" value="$(arg base_frame)"/>

    <param name="goal_topic" value="/exploration/goal"/>
    <param name="corridor_topic" value="/exploration/corridor"/>

    <param name="lock_to_corridor" value="true"/>
    <param name="allow_interrupt" value="true"/>

    <param name="waypoint_reached_m" value="1.25"/>
    <param name="final_goal_reached_m" value="0.85"/>
    <param name="min_send_period_s" value="0.75"/>

    <param name="clear_costmaps_service" value="/move_base/clear_costmaps"/>
  </node>

</launch>